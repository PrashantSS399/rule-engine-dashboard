
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Deloitte | Business Rule Engine</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --deloitte-green: #86BC25;
      --deloitte-dark-green: #2E7D32;
      --deloitte-dark: #2C2C2C;
      --deloitte-light: #F5F5F5;
    }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    .param-description {
      display: none;
      background-color: #f8fafc;
      border-left: 4px solid var(--deloitte-green);
      padding: 0.75rem;
      margin-top: 0.5rem;
      font-size: 0.875rem;
      border-radius: 0 4px 4px 0;
    }
    .function-card:hover {
      background-color: rgba(134, 188, 37, 0.05);
      border-left: 3px solid var(--deloitte-green);
    }
    .level-info {
      background-color: white;
      border-radius: 6px;
      padding: 1.25rem;
      margin-bottom: 1.5rem;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
      border-top: 3px solid;
    }
    .level-0 {
      border-top-color: var(--deloitte-green);
    }
    .level-1 {
      border-top-color: #FFC72C;
    }
    .level-2 {
      border-top-color: #D50000;
    }
    .level-badge {
      display: inline-flex;
      align-items: center;
      padding: 0.25rem 0.75rem;
      border-radius: 12px;
      font-weight: 600;
      font-size: 0.75rem;
      margin-right: 0.75rem;
    }
    .badge-0 {
      background-color: var(--deloitte-green);
      color: white;
    }
    .badge-1 {
      background-color: #FFC72C;
      color: var(--deloitte-dark);
    }
    .badge-2 {
      background-color: #D50000;
      color: white;
    }
    .deloitte-header {
      background-color: white;
      border-bottom: 1px solid #e5e7eb;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    .deloitte-btn-primary {
      background-color: var(--deloitte-green);
      color: white;
      transition: all 0.2s;
    }
    .deloitte-btn-primary:hover {
      background-color: var(--deloitte-dark-green);
      transform: translateY(-1px);
    }
    .deloitte-card {
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.05);
      border: 1px solid #e5e7eb;
    }
    .section-title {
      color: var(--deloitte-dark);
      position: relative;
      padding-left: 1rem;
    }
    .section-title:before {
      content: '';
      position: absolute;
      left: 0;
      top: 0;
      bottom: 0;
      width: 4px;
      background: var(--deloitte-green);
      border-radius: 2px;
    }
  </style>
</head>
<body class="bg-gray-50 text-gray-800">
<!-- Header -->
<header class="deloitte-header py-4 px-6 sticky top-0 z-10">
  <div class="max-w-7xl mx-auto flex justify-between items-center">
    <div class="flex items-center space-x-2">
      <svg width="32" height="32" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M16 32C24.8366 32 32 24.8366 32 16C32 7.16344 24.8366 0 16 0C7.16344 0 0 7.16344 0 16C0 24.8366 7.16344 32 16 32Z" fill="#86BC25"/>
        <path d="M22.4 9.6001H9.6V22.4001H22.4V9.6001Z" fill="white"/>
      </svg>
      <h1 class="text-xl font-bold text-gray-800">Deloitte Business Rule Engine</h1>
    </div>
    <div class="text-sm text-gray-600">
      <i class="fas fa-user-circle mr-1"></i> Admin Dashboard
    </div>
  </div>
</header>

<main class="py-6 px-4 max-w-7xl mx-auto">
 <!-- Dashboard Overview -->
<div class="mb-8 deloitte-card p-6">
  <h2 class="text-2xl font-semibold mb-2 text-gray-800">Rule Engine Dashboard</h2>
  <p class="text-gray-600 mb-4">Manage and execute business rules across customer, account, and transaction data.</p>
  <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
    <div class="bg-blue-50 p-4 rounded-lg border border-blue-100">
      <div class="flex items-center">
        <div class="p-2 rounded-full bg-blue-100 text-blue-600 mr-3">
          <i class="fas fa-database"></i>
        </div>
        <div>
          <h3 class="font-medium text-gray-700">Functions</h3>
          <p class="text-2xl font-bold">7</p>
        </div>
      </div>
    </div>
    <div class="bg-purple-50 p-4 rounded-lg border border-purple-100">
      <div class="flex items-center">
        <div class="p-2 rounded-full bg-purple-100 text-purple-600 mr-3">
          <i class="fas fa-layer-group"></i>
        </div>
        <div>
          <h3 class="font-medium text-gray-700">Levels</h3>
          <p class="text-2xl font-bold">3</p>
        </div>
      </div>
    </div>
  </div>
</div>
<!-- Function Section -->
<div class="bg-white p-6 rounded-lg border border-gray-200 shadow-md mt-4">
  <h2 class="text-xl font-semibold mb-4 text-gray-800">üßÆ DAL Architecture</h2>

  <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
    <!-- Column 1: L0 Functions -->
    <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
      <h3 class="text-sm font-semibold text-gray-700 mb-2">LEVEL 0 [Base Level Functions]</h3>

        <!-- get_customers -->
        <div class="function-card p-3 rounded-md cursor-pointer border border-gray-200" onclick="toggleDescription('get_customers_desc')">
          <div class="flex items-center gap-2">
            <span class="level-badge badge-0">LEVEL 0</span>
            <div class="font-semibold text-gray-800">get_customers</div>
          </div>
          <div class="text-sm text-gray-600 mt-1">Retrieves customer data with various filtering options</div>
          <div id="get_customers_desc" class="param-description mt-2 text-sm space-y-1 hidden">
    <div><strong>customer_id</strong>: Single ID or list of IDs (exact match)</div>
    <div><strong>name</strong>: Single name or list of names (exact or partial match)</div>
    <div><strong>city</strong>: Filter by single or multiple city names (exact or partial match)</div>
    <div><strong>update_date</strong>: Single date or list of dates (format: YYYY-MM-DD)</div>
    <div><strong>exact_match</strong>: Set to <code>false</code> to allow partial matching (default: true)</div>
    <div><strong>min_update_date</strong>: Minimum update date (inclusive)</div>
    <div><strong>max_update_date</strong>: Maximum update date (inclusive)</div>
    <div><strong>select_columns</strong>: Specify column name(s) to return (comma-separated or list)</div>
          </div>
        </div>

        <!-- get_accounts -->
        <div class="function-card p-3 rounded-md cursor-pointer border border-gray-200" onclick="toggleDescription('get_accounts_desc')">
          <div class="flex items-center gap-2">
            <span class="level-badge badge-0">LEVEL 0</span>
            <div class="font-semibold text-gray-800">get_accounts</div>
          </div>
          <div class="text-sm text-gray-600 mt-1">Retrieves account data with filtering capabilities</div>
          <div id="get_accounts_desc" class="param-description mt-2 text-sm space-y-1 hidden">
    <div><strong>account_no</strong>: Single or list of account numbers</div>
    <div><strong>account_type</strong>: Single or list of account types (e.g., savings, current)</div>
    <div><strong>customer_id</strong>: Single or list of customer IDs</div>
    <div><strong>account_status</strong>: Single or list of statuses (e.g., active, closed)</div>
    <div><strong>activation_date</strong>: Single or list of activation dates (format: YYYY-MM-DD)</div>
    <div><strong>exact_match</strong>: Set to <code>false</code> for partial matching (default: true)</div>
    <div><strong>min_activation_date</strong>: Minimum activation date (inclusive)</div>
    <div><strong>max_activation_date</strong>: Maximum activation date (inclusive)</div>
    <div><strong>select_columns</strong>: Specify column(s) to return (comma-separated or as a list)</div>
          </div>
        </div>

        <!-- get_transactions -->
        <div class="function-card p-3 rounded-md cursor-pointer border border-gray-200" onclick="toggleDescription('get_transactions_desc')">
          <div class="flex items-center gap-2">
            <span class="level-badge badge-0">LEVEL 0</span>
            <div class="font-semibold text-gray-800">get_transactions</div>
          </div>
          <div class="text-sm text-gray-600 mt-1">Retrieves transaction data with various filters</div>
          <div id="get_transactions_desc" class="param-description mt-2 text-sm space-y-1 hidden">
    <div><strong>transaction_id</strong>: Filter by transaction ID(s)</div>
    <div><strong>account_no</strong>: Account number(s) involved</div>
    <div><strong>customer_id</strong>: Customer ID(s) involved</div>
    <div><strong>amount</strong>: Exact amount or list of exact amounts</div>
    <div><strong>min_amount</strong>: Minimum amount threshold</div>
    <div><strong>max_amount</strong>: Maximum amount threshold</div>
    <div><strong>transaction_time</strong>: Specific timestamp(s) (format: YYYY-MM-DD HH:MM:SS)</div>
    <div><strong>min_transaction_time</strong>: Start of time window (inclusive)</div>
    <div><strong>max_transaction_time</strong>: End of time window (inclusive)</div>
    <div><strong>select_columns</strong>: Column name or list of columns to include in output</div>
          </div>
        </div>
      </div>

    <!-- Column 2 -->
      <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
      <h3 class="text-sm font-semibold text-gray-700 mb-2">LEVEL 1 [Joined Level Functions]</h3>

        <!-- multi_join_cust_acc -->
        <div class="function-card p-3 rounded-md cursor-pointer border border-gray-200" onclick="toggleDescription('multi_join_cust_acc_desc')">
          <div class="flex items-center gap-2">
            <span class="level-badge badge-1">LEVEL 1</span>
            <div class="font-semibold text-gray-800">multi_join_cust_acc</div>
          </div>
          <div class="text-sm text-gray-600 mt-1">Joins customer and account data</div>
          <div id="multi_join_cust_acc_desc" class="param-description mt-2 text-sm space-y-1 hidden">
    <div><strong>join_type</strong>: Type of join (<code>'left'</code>, <code>'inner'</code>)</div>
    <div><strong>customer_on</strong>: Column(s) in customer data to join on (string or list)</div>
    <div><strong>account_on</strong>: Column(s) in account data to join on (string or list)</div>
    <div><strong>customer_filters</strong>: Dictionary of filters to apply on customers</div>
    <div><strong>account_filters</strong>: Dictionary of filters to apply on accounts</div>
    <div><strong>cust</strong>: Optional pre-filtered customer DataFrame</div>
    <div><strong>acc</strong>: Optional pre-filtered account DataFrame</div>
    <div><strong>select_columns</strong>: Column name(s) to return (single or list)</div>
          </div>
        </div>

        <!-- multi_join_cust_tran -->
        <div class="function-card p-3 rounded-md cursor-pointer border border-gray-200" onclick="toggleDescription('multi_join_cust_tran_desc')">
          <div class="flex items-center gap-2">
            <span class="level-badge badge-1">LEVEL 1</span>
            <div class="font-semibold text-gray-800">multi_join_cust_tran</div>
          </div>
          <div class="text-sm text-gray-600 mt-1">Joins customer and transaction data</div>
          <div id="multi_join_cust_tran_desc" class="param-description mt-2 text-sm space-y-1 hidden">
    <div><strong>join_type</strong>: Type of SQL join (<code>'left'</code>, <code>'inner'</code>)</div>
    <div><strong>customer_on</strong>: Key(s) from customer table (<code>str</code> or <code>List[str]</code>)</div>
    <div><strong>transaction_on</strong>: Key(s) from transaction table (<code>str</code> or <code>List[str]</code>)</div>
    <div><strong>customer_filters</strong>: Dictionary of filters to apply on customers (if <code>cust</code> not provided)</div>
    <div><strong>transaction_filters</strong>: Dictionary of filters to apply on transactions (if <code>tran</code> not provided)</div>
    <div><strong>cust</strong>: Optional pre-filtered customer <code>DataFrame</code></div>
    <div><strong>tran</strong>: Optional pre-filtered transaction <code>DataFrame</code></div>
    <div><strong>select_columns</strong>: Column name(s) to return (<code>str</code> or <code>List[str]</code>)</div>
          </div>
        </div>

        <!-- multi_join_acc_tran -->
        <div class="function-card p-3 rounded-md cursor-pointer border border-gray-200" onclick="toggleDescription('multi_join_acc_tran_desc')">
          <div class="flex items-center gap-2">
            <span class="level-badge badge-1">LEVEL 1</span>
            <div class="font-semibold text-gray-800">multi_join_acc_tran</div>
          </div>
          <div class="text-sm text-gray-600 mt-1">Joins account and transaction data</div>
          <div id="multi_join_acc_tran_desc" class="param-description mt-2 text-sm space-y-1 hidden">
    <div><strong>join_type</strong>: Type of join (<code>'left'</code>, <code>'inner'</code>, etc.). Default is <code>'left'</code></div>
    <div><strong>account_on</strong>: Key(s) from account table (<code>str</code> or <code>List[str]</code>)</div>
    <div><strong>transaction_on</strong>: Key(s) from transaction table (<code>str</code> or <code>List[str]</code>)</div>
    <div><strong>account_filters</strong>: Dictionary of filters for <code>get_accounts()</code> (if <code>acc</code> not provided)</div>
    <div><strong>transaction_filters</strong>: Dictionary of filters for <code>get_transactions()</code> (if <code>tran</code> not provided)</div>
    <div><strong>acc</strong>: Optional pre-filtered <code>DataFrame</code> of accounts</div>
    <div><strong>tran</strong>: Optional pre-filtered <code>DataFrame</code> of transactions</div>
    <div><strong>select_columns</strong>: Optional. Column name(s) to return (<code>str</code> or <code>List[str]</code>)</div>
          </div>
        </div>
      </div>
      <!-- Column 3: L2 Functions (Moved here) -->
    <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
      <h3 class="text-sm font-semibold text-gray-700 mb-2">LEVEL 2 [Super Function]</h3>
      <div class="space-y-3">
        <div class="function-card p-3 rounded-md cursor-pointer border border-gray-200" onclick="toggleDescription('super_join_cust_acc_tran_desc')">
          <div class="flex items-center gap-2">
            <span class="level-badge badge-2">LEVEL 2</span>
            <div class="font-semibold text-gray-800">super_join_cust_acc_tran</div>
          </div>
          <div class="text-sm text-gray-600 mt-1">Joins customer, account, and transaction data</div>
          <div id="super_join_cust_acc_tran_desc" class="param-description mt-2 text-sm space-y-1 hidden">
    <div><strong>join_type</strong>: Type of join (<code>'left'</code>, <code>'inner'</code>). Default is <code>'left'</code></div>
    <div><strong>customer_filters</strong>: Dictionary of filters to apply to customers</div>
    <div><strong>account_filters</strong>: Dictionary of filters to apply to accounts</div>
    <div><strong>transaction_filters</strong>: Dictionary of filters to apply to transactions</div>
    <div><strong>customer_key</strong>: Key(s) to join customers and accounts (<code>str</code> or <code>List[str]</code>)</div>
    <div><strong>account_key</strong>: Key(s) to join accounts and transactions (<code>str</code> or <code>List[str]</code>)</div>
    <div><strong>transaction_key</strong>: Key(s) to join transactions (if needed)</div>
    <div><strong>cust</strong>: Optional pre-filtered <code>DataFrame</code> for customers</div>
    <div><strong>acc</strong>: Optional pre-filtered <code>DataFrame</code> for accounts</div>
    <div><strong>tran</strong>: Optional pre-filtered <code>DataFrame</code> for transactions</div>
    <div><strong>cust_acc_df</strong>: Optional pre-joined <code>DataFrame</code> for customer-account</div>
    <div><strong>cust_tran_df</strong>: Optional pre-joined <code>DataFrame</code> for customer-transaction</div>
    <div><strong>acc_tran_df</strong>: Optional pre-joined <code>DataFrame</code> for account-transaction</div>
    <div><strong>select_columns</strong>: Optional. Return only selected column(s) (<code>str</code> or <code>List[str]</code>)</div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
  <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
    <!-- Left Column -->
    <div class="space-y-6">
      <!-- Rules Section -->
      <div class="deloitte-card p-6">
        <h2 class="section-title text-xl font-semibold mb-4">üìã Business Rules</h2>
        <div class="mb-4">
          <pre id="rules" class="bg-gray-50 p-4 rounded overflow-auto text-sm whitespace-pre-wrap font-mono border border-gray-200 max-h-60"></pre>
        </div>
        <button onclick="fetchRules()" class="deloitte-btn-primary px-4 py-2 rounded-md font-medium">
          <i class="fas fa-sync-alt mr-2"></i>Refresh Rules
        </button>
      </div>

      <!-- Run Rule Section -->
      <div class="deloitte-card p-6">
        <h2 class="section-title text-xl font-semibold mb-4">‚ñ∂Ô∏è Execute Rule</h2>
        <div class="flex items-center space-x-2 mb-4">
          <input id="rule_id_input" class="border px-3 py-2 rounded-md flex-grow" placeholder="Enter rule ID (e.g., rule_01)">
          <button onclick="runRule()" class="deloitte-btn-primary px-4 py-2 rounded-md font-medium">
            <i class="fas fa-play mr-1"></i>Run
          </button>
        </div>
        <!-- JSON Output for Rule -->
<div class="mt-4">
  <label class="block text-sm font-medium text-gray-700 mb-1">Raw JSON Output</label>
  <pre id="rule_json_output" class="bg-gray-100 text-sm p-4 rounded-md overflow-auto max-h-60 border border-gray-300 whitespace-pre-wrap"></pre>
</div>

<!-- Download Button -->
<button onclick="downloadRuleJSON()" class="mt-2 px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">
  ‚¨áÔ∏è Download Rule Output JSON
</button>

 <div id="rule_output" class="bg-white p-4 rounded-md shadow overflow-auto">
  <table class="min-w-full table-auto text-sm w-full">
    <thead>
      <tr>
        <th class="w-1/4 text-left px-2 py-1 border-b">Account Number</th>
        <th class="w-1/4 text-left px-2 py-1 border-b">Account Type</th>
        <th class="w-1/4 text-left px-2 py-1 border-b">Customer ID</th>
        <th class="w-1/4 text-left px-2 py-1 border-b">Status</th>
      </tr>
    </thead>
    <tbody>
      <!-- Your data rows dynamically inserted here -->
    </tbody>
  </table>
</div>

      </div>
    </div>

    <!-- Right Column -->
    <div class="space-y-6">
      <!-- Add Rule Section -->
      <div class="deloitte-card p-6">
        <h2 class="section-title text-xl font-semibold mb-4">üÜï Create New Rule</h2>

        <div class="space-y-3 mb-4">
          <div class="level-info level-0">
            <div class="flex items-center mb-1">
              <span class="level-badge badge-0">Level 0</span>
              <h3 class="font-bold text-gray-800">Basic Data Retrieval</h3>
            </div>
            <p class="text-sm pl-8 text-gray-600">Foundational functions that fetch raw, unjoined data from the database. They are typically used as a base for analysis or filtering before applying any business logic or joining operations. They offer complete flexibility with multiple filtering options.</p>
          </div>

          <div class="level-info level-1">
            <div class="flex items-center mb-1">
              <span class="level-badge badge-1">Level 1</span>
              <h3 class="font-bold text-gray-800">Joined Data Retrieval</h3>
            </div>
            <p class="text-sm pl-8 text-gray-600">Functions that combine two related entities such as customers and accounts, or accounts and transactions. They're commonly used for identifying relationships or cross-checking data between two tables. Ideal for use cases where a simple join operation is needed to understand dependencies or relationships in the data.</p>
          </div>

          <div class="level-info level-2">
            <div class="flex items-center mb-1">
              <span class="level-badge badge-2">Level 2</span>
              <h3 class="font-bold text-gray-800">Super Function</h3>
            </div>
            <p class="text-sm pl-8 text-gray-600">Advanced utility that joins all three core tables: customers, accounts, and transactions. Allows detailed correlation and traceability across the entire customer lifecycle. Highly useful for detecting anomalies, customer behavior analytics, and policy compliance.</p>
          </div>
        </div>

        <form id="add_rule_form" class="grid grid-cols-1 gap-3">
          <div class="grid grid-cols-2 gap-3">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Rule ID</label>
              <input name="rule_id" class="w-full border px-3 py-2 rounded-md" placeholder="rule_20">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Level</label>
              <select name="level" class="w-full border px-3 py-2 rounded-md">
                <option value="0">Level 0 (Basic Functions)</option>
                <option value="1">Level 1 (Joined Functions)</option>
                <option value="2">Level 2 (Super Functions)</option>
              </select>
            </div>
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Description</label>
            <input name="description" class="w-full border px-3 py-2 rounded-md" placeholder="Rule description">
          </div>

          <div class="grid grid-cols-3 gap-3">
              <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">Function</label>
                  <select name="function_name" id="function_dropdown" onchange="populateColumns()" class="w-full border px-3 py-2 rounded-md">
                    <option value="">Select function</option>
                    <option value="get_customers">get_customers</option>
                    <option value="get_accounts">get_accounts</option>
                    <option value="get_transactions">get_transactions</option>
                    <option value="multi_join_cust_acc">multi_join_cust_acc</option>
                    <option value="multi_join_cust_tran">multi_join_cust_tran</option>
                    <option value="multi_join_acc_tran">multi_join_acc_tran</option>
                    <option value="super_join_cust_acc_tran">super_join_cust_acc_tran</option>
                  </select>
                </div>
             </div>
            <div>
            <div>

                </select>

            </div>
            <div>

            </div>
          </div>

          <div>

          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Custom Code</label>
            <textarea name="code" class="w-full border px-3 py-2 rounded-md h-24" placeholder="Custom rule code using 'df' as DataFrame"></textarea>
          </div>
          <!-- üì¶ Multiple Conditions -->
            <div id="conditions_container" class="space-y-3 mb-3">
              <div class="condition_block grid grid-cols-3 gap-3">
                <select name="column" class="column_dropdown border px-3 py-2 rounded-md">
                  <option value="">Select column</option>
                </select>
                <select name="condition" class="border px-3 py-2 rounded-md">
                  <option value="==">==</option>
                  <option value="!=">!=</option>
                  <option value=">">&gt;</option>
                  <option value=">=">&gt;=</option>
                  <option value="<">&lt;</option>
                  <option value="<=">&lt;=</option>
                </select>
                <input name="value" type="text" class="border px-3 py-2 rounded-md" placeholder="Enter value" />
              </div>
            </div> 
            <button type="button" onclick="addCondition()" class="mt-1 px-3 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
              ‚ûï Add Condition
            </button>
        </form>

                <button onclick="addRule()" class="deloitte-btn-primary w-full mt-3 px-4 py-2 rounded-md font-medium">
          <i class="fas fa-plus mr-2"></i>Add Rule
        </button>
              </div>
            </div>
          </div>
        <script>
        function toggleDescription(id) {
          const el = document.getElementById(id);
          if (el) el.classList.toggle('hidden');
        }
        </script>


    <!-- ‚öôÔ∏è Function Execution Card -->
<div class="bg-white p-6 rounded-lg border border-gray-200 shadow-md mt-6">
  <h2 class="text-xl font-semibold mb-4 text-gray-800">‚öôÔ∏è Function Execution</h2>

  <!-- Function Dropdown -->
  <div class="mb-4">
    <label class="block text-sm font-medium text-gray-700 mb-2">Select Function</label>
    <select id="function_select" onchange="updateFunctionFields()" class="border border-gray-300 px-3 py-2 rounded-md w-full focus:outline-none focus:ring-2 focus:ring-blue-500">
      <option value="get_customers">get_customers</option>
      <option value="get_accounts">get_accounts</option>
      <option value="get_transactions">get_transactions</option>
      <option value="multi_join_cust_acc">multi_join_cust_acc</option>
      <option value="multi_join_cust_tran">multi_join_cust_tran</option>
      <option value="multi_join_acc_tran">multi_join_acc_tran</option>
      <option value="super_join_cust_acc_tran">super_join_cust_acc_tran</option>
    </select>
  </div>

  <!-- Dynamic Input Fields -->
  <div id="function_inputs" class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
    <!-- Populated dynamically via JS -->
  </div>

  <!-- Execute Button -->
  <button onclick="runFunction()" class="bg-green-400 text-white hover:bg-green-600 transition-colors w-full px-4 py-2 rounded-md font-medium">
    <i class="fas fa-play mr-2"></i> Execute Function
  </button>

  <!-- Output Section -->
  <div class="mt-6">
    <label class="block text-sm font-medium text-gray-700 mb-2">Results</label>
    <div id="function_output" class="bg-gray-50 p-4 rounded-md overflow-auto text-sm border border-gray-200 max-h-60">
      <!-- Output shown here -->
    </div>
  </div>
</div>

    </div>
  </div>

  <!-- Delete Rule Section -->
  <div class="mt-6 deloitte-card p-6">
    <h2 class="section-title text-xl font-semibold mb-4">‚ùå Rule Management</h2>
    <div class="flex items-center space-x-3">
      <input id="delete_rule_id" class="border px-3 py-2 rounded-md flex-grow" placeholder="Enter Rule ID to Delete">
      <button onclick="deleteRule()" class="deloitte-btn-primary px-4 py-2 rounded-md font-medium bg-red-600 hover:bg-red-700">
        <i class="fas fa-trash-alt mr-1"></i>Delete Rule
      </button>
    </div>
  </div>
  <!-- JSON Viewer -->
<div class="mt-4">
  <label class="block text-sm font-medium text-gray-700 mb-1">Raw JSON Output</label>
  <pre id="json_output" class="bg-gray-100 text-sm p-4 rounded-md overflow-auto max-h-60 border border-gray-300 whitespace-pre-wrap"></pre>
</div>
<!-- Download Button -->
<button onclick="downloadJSON()" class="mt-2 px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">
  ‚¨áÔ∏è Download JSON
</button>



</main>

<script>
  const functionParams = {
    get_customers: ["customer_id","name", "city", "update_date", "exact_match", "min_update_date", "max_update_date","select_columns"],
    get_accounts: ["account_no", "account_type", "customer_id", "account_status", "activation_date", "exact_match", "min_activation_date", "max_activation_date","select_columns"],
    get_transactions: ["transaction_id", "account_no", "customer_id", "amount", "transaction_time", "min_transaction_time", "max_transaction_time", "min_amount", "max_amount","select_columns"],
    multi_join_cust_acc: ["join_type", "customer_on", "account_on", "customer_filters", "account_filters","select_columns"],
    multi_join_cust_tran: ["join_type", "customer_on", "transaction_on", "customer_filters", "transaction_filters","select_columns"],
    multi_join_acc_tran: ["join_type", "account_on", "transaction_on", "account_filters", "transaction_filters","select_columns"],
    super_join_cust_acc_tran: ["join_type", "customer_account_key", "account_transaction_key", "customer_filters", "account_filters", "transaction_filters","select_columns"]
  };

  function toggleDescription(id) {
    const desc = document.getElementById(id);
    desc.style.display = desc.style.display === 'none' ? 'block' : 'none';
  }

  function fetchRules() {
    fetch('/rules')
      .then(res => res.text())
      .then(data => {
        document.getElementById("rules").textContent = data;
        // Update rules count
        const rules = data.split('\n').filter(line => line.trim().startsWith('rule_'));
        document.getElementById("rules-count").textContent = rules.length;
      });
  }

function runRule() {
  const ruleId = document.getElementById("rule_id_input").value;
  if (!ruleId) return alert("Please enter a rule ID");

  fetch('/run_rule/' + ruleId)
    .then(res => res.json())
    .then(data => {
      if (!data.result || data.result.length === 0) {
        document.getElementById("rule_output").innerHTML = "<div class='text-gray-500'>No data returned</div>";
        document.getElementById("rule_json_output").textContent = "";
        return;
      }

      // ‚úÖ Show as table
      displayTable("rule_output", data.result);

      // ‚úÖ Save and show as JSON
      window.latestRuleResult = data.result;
      const jsonBox = document.getElementById("rule_json_output");
      if (jsonBox) {
        jsonBox.textContent = JSON.stringify(data.result, null, 2);
      }
    })
    .catch(err => alert("Rule Error: " + err));
}


function runFunction() {
  const func = document.getElementById("function_select").value;
  const inputs = document.querySelectorAll("#function_inputs input, #function_inputs select");
  const params = {};

  inputs.forEach(input => {
    let value = input.value.trim();
    if (!value) return;

    if (value.includes(',')) {
      const items = value.split(',').map(v => v.trim());
      params[input.name] = items.map(v => {
        if (v.toLowerCase() === "true") return true;
        if (v.toLowerCase() === "false") return false;
        return isNaN(v) ? v : parseFloat(v);
      });
    } else {
      if (value.toLowerCase() === "true") {
        params[input.name] = true;
      } else if (value.toLowerCase() === "false") {
        params[input.name] = false;
      } else {
        params[input.name] = isNaN(value) ? value : parseFloat(value);
      }
    }
  });

  fetch('/run_function', {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ function_name: func, parameters: params })
  })
  .then(res => res.json())
  .then(data => {
    displayTable("function_output", data);

    // ‚úÖ Save raw result for download
    window.latestFunctionResult = data;

    // ‚úÖ Show in JSON box if it exists
    const jsonBox = document.getElementById("json_output");
    if (jsonBox) {
      jsonBox.textContent = JSON.stringify(data, null, 2);
    }
  })
  .catch(err => alert("Function Error: " + err));
}




  function displayTable(divId, data) {
    const div = document.getElementById(divId);
    if (!data || data.length === 0) {
      div.innerHTML = "<div class='text-center py-4 text-gray-500'>No data returned</div>";
      return;
    }

    const keys = Object.keys(data[0]);
    let html = "<div class='overflow-x-auto'><table class='min-w-full divide-y divide-gray-200'><thead class='bg-gray-100'><tr>";
    keys.forEach(key => {
      html += `<th scope='col' class='px-4 py-2 text-left text-xs font-medium text-gray-700 uppercase tracking-wider'>${key}</th>`;
    });
    html += "</tr></thead><tbody class='bg-white divide-y divide-gray-200'>";

    data.slice(0, 100).forEach((row, i) => {
      html += "<tr class='" + (i % 2 === 0 ? 'bg-white' : 'bg-gray-50') + "'>";
      keys.forEach(key => {
        const val = row[key];
        html += `<td class='px-4 py-2 text-sm ${typeof val === 'number' ? 'text-right font-mono' : 'text-left'}'>${val || ''}</td>`;
      });
      html += "</tr>";
    });
    html += "</tbody></table></div>";

    if (data.length > 100) {
      html += `<div class='text-xs text-gray-500 mt-2'>Showing 100 of ${data.length} rows</div>`;
    }

    div.innerHTML = html;
  }

  function updateFunctionFields() {
    const func = document.getElementById("function_select").value;
    const container = document.getElementById("function_inputs");
    container.innerHTML = "";
    (functionParams[func] || []).forEach(p => {
      const div = document.createElement("div");
      div.className = "space-y-1";

      const label = document.createElement("label");
      label.textContent = p;
      label.className = "block text-sm font-medium text-gray-700";

      const input = document.createElement("input");
      input.name = p;
      input.placeholder = p;
      input.className = "w-full border px-3 py-2 rounded-md text-sm";

      div.appendChild(label);
      div.appendChild(input);
      container.appendChild(div);
    });
  }

function addRule() {
  const form = document.getElementById("add_rule_form");
  const data = Object.fromEntries(new FormData(form).entries());

  if (!data.rule_id || !data.description) {
    return alert("‚ùå Please fill in all required fields");
  }

  const isCustomCode = data.code && data.code.trim() !== "";

  // Collect all condition blocks
  const conditionBlocks = document.querySelectorAll(".condition_block");

  const conditions = Array.from(conditionBlocks).map(block => {
    const column = block.querySelector('[name="column"]').value;
    const condition = block.querySelector('[name="condition"]').value;
    let value = block.querySelector('[name="value"]').value;

    // Try to convert value to number if applicable
    if (!isNaN(value) && value.trim() !== "") value = parseFloat(value);

    return { column, condition, value };
  }).filter(c => c.column && c.condition && c.value !== "");

  // At least one method should be provided
  if (!isCustomCode && conditions.length === 0) {
    return alert("‚ùå Please provide either conditions or custom rule code.");
  }

  const payload = {
    rule_id: data.rule_id,
    description: data.description,
    level: parseInt(data.level || 0),
    function_name: data.function_name,
    code: data.code || "",
    extra: {},
    conditions: conditions  // ‚Üê Proper condition array
  };

  fetch('/add_rule', {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(payload)
  })
  .then(res => {
    if (res.ok) {
      alert("‚úÖ Rule added successfully");
      fetchRules();
      form.reset();
    } else {
      res.json().then(e => {
        console.error("Error Response:", e);
        if (Array.isArray(e.detail)) {
          alert("‚ùå Error:\n" + e.detail.map(d => d.msg || JSON.stringify(d)).join('\n'));
        } else {
          alert("‚ùå Error: " + (e.detail || JSON.stringify(e)));
        }
      });
    }
  });
}


  function deleteRule() {
    const id = document.getElementById("delete_rule_id").value;
    if (!id) return alert("Please enter a rule ID");

    if (!confirm(`Are you sure you want to delete rule ${id}?`)) return;

    fetch('/delete_rule/' + id, { method: "DELETE" })
      .then(res => {
        if (res.ok) {
          alert("üóëÔ∏è Rule deleted successfully");
          fetchRules();
          document.getElementById("delete_rule_id").value = "";
        }
        else res.json().then(e => alert("Error: " + (e.detail || "Failed to delete rule")));
      });
  }

  // Initialize
  document.addEventListener('DOMContentLoaded', function() {
    updateFunctionFields();
    fetchRules();
  });
</script>
<script>
function downloadJSON() {
  if (!window.latestFunctionResult || window.latestFunctionResult.length === 0) {
    return alert("‚ö†Ô∏è No data available to download.");
  }

  const blob = new Blob([JSON.stringify(window.latestFunctionResult, null, 2)], {
    type: "application/json",
  });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "function_output.json";
  a.click();
  URL.revokeObjectURL(url);
}
function downloadRuleJSON() {
  if (!window.latestRuleResult || window.latestRuleResult.length === 0) {
    return alert("‚ö†Ô∏è No rule result to download.");
  }

  const blob = new Blob([JSON.stringify(window.latestRuleResult, null, 2)], {
    type: "application/json",
  });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "rule_output.json";
  a.click();
  URL.revokeObjectURL(url);
}

const functionColumnsMap = {
  get_customers: ["customer_id", "name", "city", "dob"],
  get_accounts: ["account_no", "customer_id", "account_type", "account_status"],
  get_transactions: ["transaction_id", "account_no", "customer_id", "amount", "transaction_time"],
  multi_join_cust_acc: ["customer_id", "name","city", "account_no", "account_type","account_status"],
  multi_join_cust_tran: ["customer_id", "name", "city" ,"account_no", "transaction_id", "amount", "transaction_time",],
  multi_join_acc_tran: ["account_no", "account_type","account_status", "customer_id","transaction_id", "amount"],
  super_join_cust_acc_tran: ["customer_id", "name","city","dob","account_no", "account_type","account_status","transaction_id", "amount","transaction_time"]
};

function populateColumns() {
  const func = document.getElementById("function_dropdown").value;
  const columns = functionColumnsMap[func] || [];

  // Update all column_dropdowns
  document.querySelectorAll(".column_dropdown").forEach(select => {
    select.innerHTML = `<option value="">Select column</option>`;
    columns.forEach(col => {
      const option = document.createElement("option");
      option.value = col;
      option.textContent = col;
      select.appendChild(option);
    });
  });
}

function addCondition() {
  const container = document.getElementById("conditions_container");
  const template = document.querySelector(".condition_block");
  const newBlock = template.cloneNode(true);

  // Clear values
  newBlock.querySelector('[name="column"]').value = "";
  newBlock.querySelector('[name="condition"]').value = "==";
  newBlock.querySelector('[name="value"]').value = "";

  container.appendChild(newBlock);

  // Re-populate ALL column dropdowns (including the new one)
  populateColumns();
}




</script>
</body>
</html>
